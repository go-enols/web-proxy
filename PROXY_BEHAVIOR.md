# 代理行为说明

## 修改概述

本次修改将代理服务器从**透明隧道模式**改为**真正的代理转发模式**，确保目标服务器无法获取到真实的客户端IP地址。

## 关键变化

### 1. HTTPS隧道处理 (HandleProxyTunneling & HandleDirectTunneling)

**修改前（透明隧道）：**
- 代理服务器仅作为数据转发通道
- 客户端与目标服务器建立直接的TLS连接
- 目标服务器能看到客户端的真实IP地址

**修改后（代理转发）：**
- 代理服务器作为中间人，分别与客户端和目标服务器建立连接
- 客户端 ↔ 代理服务器 ↔ 目标服务器
- 目标服务器只能看到代理服务器的IP地址
- 增加了连接管理和错误处理

### 2. HTTP请求处理 (HandleProxyHTTP & HandleDirectHTTP)

**修改前：**
- 使用 `httputil.NewSingleHostReverseProxy(nil)`
- 可能会泄露客户端信息

**修改后：**
- 主动移除可能暴露客户端信息的HTTP头部：
  - `X-Forwarded-For`
  - `X-Real-IP`
  - `X-Forwarded-Proto`
  - `X-Forwarded-Host`
- 使用自定义HTTP客户端重新发起请求
- 完全控制请求和响应的转发过程

## 隐私保护效果

### 对目标服务器
- ✅ 无法获取客户端真实IP
- ✅ 无法通过HTTP头部获取客户端信息
- ✅ 只能看到代理服务器的连接

### 对客户端
- ✅ 保持原有的使用体验
- ✅ 支持HTTP和HTTPS协议
- ✅ 支持认证机制

## 技术实现细节

### 连接管理
- 添加了 `defer` 语句确保连接正确关闭
- 使用 `select {}` 阻塞等待连接结束
- 改进了错误处理和日志记录

### 请求转发
- 重新构建HTTP请求，移除敏感头部
- 保持请求方法、路径、查询参数不变
- 正确处理请求体和响应体的转发

### 代理链支持
- 二次代理模式：客户端 → 本代理 → 上级代理 → 目标服务器
- 直接代理模式：客户端 → 本代理 → 目标服务器
- 两种模式都能有效隐藏客户端真实IP

## 使用场景

这种修改特别适用于：
1. 需要隐藏客户端真实IP的场景
2. 企业内网访问外部资源
3. 隐私保护和匿名访问
4. 绕过基于IP的访问限制

## 注意事项

1. **性能影响**：代理转发模式比透明隧道模式消耗更多资源
2. **TLS证书**：HTTPS连接的证书验证由代理服务器处理
3. **连接超时**：设置了30秒的请求超时时间
4. **日志记录**：建议监控代理服务器的连接和错误日志

## 兼容性

- ✅ 保持所有原有的命令行参数
- ✅ 保持认证机制不变
- ✅ 支持HTTP和HTTPS协议
- ✅ 支持二次代理配置